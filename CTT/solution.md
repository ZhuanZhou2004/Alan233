#### 「CTT 2021 Day 1」末日魔法少女计划

出题人：李欣隆。

**Solution**

题目等价于区间半群查询，限制查询的代价（合并的区间个数）不超过 $k$，求一个预处理方案，最小化预处理代价 $m$。在预处理时，初始有区间 $[i,i+1)$，可以从区间 $[a,b),\;[b,c)$ 合并得到 $[a,c)$，合并次数为 $m$。

部分分的设置和以下算法有关。

#### 算法1

对 $k=1$，需要合并出所有 $[l,r)$ 满足 $r-l>1$。

#### 算法2

对 $k=2$，可以使用分治：
对 $[l,r)$ 合并得到每个 $[x,m)$ 和 $[m,x)$，然后递归合并 $[l,m)$ 和 $[m,r)$。

$m(n)=2m(\frac n2)+O(n)=O(n\log n)$。

#### 算法3

对 $k=3$，可以使用递归分块：
将序列分为 $\sqrt n$ 大小的块，合并出每个块区间，以及每个块的前后缀，块内递归处理。每个区间可以表示为块区间和左边的块前缀和右边的块后缀。

$m(n)=\sqrt n\cdot m(\sqrt n)+O(n)=O(n\log\log n)$。

#### 算法4

对 $k=4$，可以使用递归分治：
将序列分为 $\log n$ 大小的块，块内递归处理，块间用算法2处理，另外处理每个块的前后缀和。

$m=\frac{n}{\log n}m(\log n)+O(n)=O(n\log^*n)$。

#### 算法5

对足够大的 $k$，可以构造线段树，叶子已经有了，只需合并出内部结点。
$m(n)=O(n)$；
$k\ge 2\log_2n-O(1)$。

#### 算法6

算法 5 使用线段树导致只适用于较大的 $k$。将线段树靠近根的 $n_0$ 个结点换为其它适用于 $k=k'$ 的算法预处理，可以增大 $m$ 并适用于更小的 $k$。

$m_k(n)=O(n)+m_{k'}(n_0)$；
$k\ge 2\log_2(\frac n{n_0})+k'-O(1)$。

#### 算法7

观察算法 1,2,3,4 的特性，可以得到适用于所有 $k$ 的算法：
对序列分块，块内递归处理，块间递归到 $k-2$ 的情况处理，另外处理每个块的前后缀和，边界情况为 $k=1,2$。

$m_k(n)=\frac{n}{B(k,n)}m_{k}(B(k,n))+O(n)$。

这里需要块大小 $B$，可以使用动态规划求出一个好的分块方案。
对每个 $k$，有 $B=O(\frac{m_{k-2}(n)}n)$，这可以减小动态规划的时间复杂度。

#### 算法8

算法 7 的实现不够精细，可以和算法 6 结合使用，在线段树上层用算法 7 的方案，下层用普通的线段树结构。

#### 算法9

可以更精细地实现算法 7。
$m_k(n)$ 表示长度 $n$ 的序列，支持查询时只用 $k$ 个区间，预处理的代价；
$m_{k,1}(n)$ 表示长度 $n$ 的序列，支持查询时只用 $k$ 个区间，且查前缀只需 $1$ 个区间，预处理的代价；
$m_{k,2}(n)$ 表示长度 $n$ 的序列，支持查询时只用 $k$ 个区间，且查前后缀只需 $1$ 个区间，预处理的代价；
边界情况为 $k=0,1$ 和 $n\le k$。

对于 $m_{k,2}(n)$，需要用动态规划求出一个分块方案，其中第一个块和最后一个块内为 $m_{k,1}$，其它块内为 $m_{k,2}$；除了第一个块和最后一个块，块间递归到 $m_{k-2,2}$；前后缀和可以复用第一个块和最后一个块的结果。

$m_{k,1}(n)$ 和 $m_k(n)$ 类似处理。可以发现这样求出的方案比更简单的实现好很多。

所有子任务都保证算法 9 能通过。

---

#### 「CTT 2021 Day 1」魔塔 OL

出题人：陈松杨。

魔塔游戏，每个怪物有五个属性：它在魔塔的第 $x$ 层，两个实力分别为 $y,z$，并且打掉它要扣 $a$ 滴血，之后会回 $b$ 滴血。

现在你需要支持以下操作：

- `1 x y z a b`：增加一个怪物。这个怪物的标号是上一次怪物的标号 $+1$；
- `2 id`：删除标号为 $id$ 的怪物；
- `3 X Y Z`：提取出所有 $x\le X,y\le Y,z\le Z$ 的怪物（即偏序），求击杀它们初始最少需要多少血量。   

$1\le q\le 10^5$，怪物个数 $\le 5\cdot 10^4$。

**Solution**

无。

**反思**

场上一直在码平衡树，贼难写，还被卡常。事实上，扩展到 $k$ 维（本题 $k=4$），维度较高且数据范围为 $5\times 10^4$ 时，不妨考虑下 `bitset`，块内四毛子预处理所有状态的答案，然后用“逐块处理”的 trick 做到空间线性。

---

#### 「CTT 2021 Day 1」基因编辑

出题人：陈鸿基。

给定一个长为 $n$ 的序列 $a$，以及 $L,R$。你需要找到最短的 $l,r$ 满足 $l\le L\le R\le r$，并且不存在别的 $l',r'$ 满足 $(a_l,a_r)=(a_l',a_r')$。

$1\le n\le 10^6$。 

**Solution**

😅签到题。

---

#### 「CTT 2021 Day 2」简单数据结构

出题人：钱易。

给定一个长为 $n$ 的序列 $a$，执行 $q$ 次询问，询问有如下三种：

- `1 x`：将所有 $a_i$ 对 $x$ 取 $\min$；
- `2`：将所有 $a_i$ 变为 $a_i+i$；
- `3 l r`：查询区间 $[l,r]$ 的 $a_i$ 和。

$1\le n,q\le 2\times 10^5,0\le a_i,v\le 10^{12}$。

时间限制 $\text{3000ms}$，空间限制 $\text{512MB}$。

**Solution**

我们将被取过 $\min$ 的点为特殊点，则有如下性质：

> 特殊点的值随 $i$ 的增大单调不降。

证明：

>考虑归纳证明。一开始特殊点集为空，先进行若干次 $2$ 操作，再进行一次 $1$ 操作，此时所有 $a_i\ge x$ 的点加入特殊点集，值均变为 $x$。
>
>紧接着又进行若干次 $2$ 操作，再进行一次 $1$ 操作，有一些新点被加入特殊点集。我们只需说明这些点在特殊点集中的前驱 $\le x$ 且后继 $\ge x$ 即可。
>
>对于前驱而言，因为执行了 $1$ 操作，它的值显然 $\le x$；对于后继而言，它每次 $2$ 操作 + 的值比该点多，所以后继必然也变成了 $x$。

接下来，问题转化为如下两个任务：

- 计算出每个位置变成特殊点的时刻；
- 给特殊点集开个线段树，每次线段树二分找出后缀，并进行区间覆盖。

前者可以用整体二分 + 李超树做到 $\mathcal O(n\log 值域\log n)$，也可以用 KTT 做到**实际效果** $\mathcal O(n\log 值域 )$，或者是整体二分时建凸包，然后用指针在凸包上单调移动做到 $\mathcal O(n \log n)$。

后者显然可以做到 $\mathcal O(n\log n)$。

时间复杂度 $\mathcal O(n\log n)$。

---

#### 「CTT 2021 Day 2」Datalab

出题人：周雨扬。

**交互题**，有一个长为 $k=13$ 的序列 $\text{sgn}$，满足 $\text{sgn}_i \in \{-1,1\}$。

假如给定一个长为 $k$ 的 `bitset` $s$，它对应的数为 $\sum\limits_{i=0}^{k-1} [s_i=1] \text{sgn}_i \cdot 2^i$。

我们定义 $a\oplus b$，每次交互给出 $a,b$，交互库返回 $g(f(A)\oplus f(B))$。

你需要在不超过 $140$ 次询问内求出 $\text{sgn}$ 数组。

**Solution**

无。

**反思**

对于交互题，我总是无从下手。我们可以采取“从一般到特殊”的思想，将 `Add(a, b)` 特殊化成 `Add(a, a)`，并从简单的情形入手，比如我们可以让 `a=100...0`，发现这可以找到下一个 $=a_0$ 的位置 $i$，并且只有 $[1,i]$ 这一段为 $1$。紧接着考虑并行，将若干次询问压缩至 $1$ 次，并对边界（相邻块撞一起）进行分析。

---

#### 「CTT 2021 Day 2」随机游走

出题人：潘骏跃。

给定一张 $n$ 个点的有向图，初始有边 $i\to i+1\ (i\in [1,n))$，你需要额外添加 $m$ 条边（可以重边、自环），使得从 $1$ 走到 $n$ 的期望步数最大。

你需要求出期望值。

$1\le n,m\le 10^9$，模数 $p$ 保证为质数，且 $2\le p\le 10^9+7$。 

**Solution**

场切，找规律题。

---

#### 「CTT 2021 Day 3」小明的树

出题人：余快。

给定一棵 $n$ 个点的以 $1$ 为根的树，以及一个 $2\sim n$ 的排列 $p$。

我们依次将 $p_i$ 点点亮。我们定义一个局面是好的，当且仅当每个点亮的点的子树全是亮的，并且它的贡献是亮连通块个数。

现在有 $q$ 次修改，每次删掉一条边，再加入一条边（保证仍然是树），求每次的贡献和。 

$1\le n,q\le 5\cdot 10^5$。

**Solution**

无。

**反思**

场上看到“每次删边再加边”，心里一发慌：哎我不会 LCT 死定了。于是敲暴力把前面 subtask 全拼满，就跑路了。

事实上，我们观察到“点亮的点的子树全亮”这个条件很别扭，不妨反面考虑：那没点亮的点不就是以 $1$ 为根的连通块吗？进而联想到倒过来考虑问题，每次拼成以 $1$ 为根的连通块，贡献是"两端点状态不同的边数"。

对于树上连通块而言，我们显然可以通过 $V-E=C$ 来判断。由于 $V-E$ 始终 $\ge 1$，所以我们在线段树维护区间最小值即可。于是我们发现这跟 LCT 半毛钱关系没有，"删边加边仍是一棵树"是出题人所要保证的条件，我们只需要利用它进行线段树操作即可。

---

#### 「CTT 2021 Day 3」出题高手

出题人：陈奇之。

给定一个序列 $a$，满足 $a_i$ 在 $[-1000,1001]$ 内随机生成。我们定义区间 $[l,r]$ 的权值为 $\frac{\sum\limits_{i=l}^{r}a_i^2}{r-l+1}$。

有 $q$ 次询问，每次查询 $[L,R]$ 内所有区间的权值最大值。

- $1\le n,q\le 10^5$；
- $n=5\cdot 10^5,q=1$。

**Solution**

场切，印象里是对于每个前缀，取单调栈里的栈顶 $2000$ 个元素，得到 $2000n$ 个候选区间。然后瞎几把预处理一下，查询是平凡的。卡卡常、调调参就过了。

---

#### 「CTT 2021 Day 3」扑克比大小

给定字符串 $s$，我们定义两个字符串 $a,b$ 的大小为 $aa\cdots a$ 和 $bb\cdots b$（即循环串）的大小。

有 $q$ 次查询，每次问 $s_{l} \cdots s_{r}$ 在 $s$ 的所有本质不同子串里的排名。

$1\le n,q\le 10^6$。

---

#### 「CTT 2021 Day 4」算术

题意见原题面。

**Solution**

【模板】阶。

**反思**

对于猜结论，看到如此复杂的转换方式，可以大胆猜想它背后有很简洁的规律。

我们可以列一些特殊情况去猜出结论来，比如找到第一个可以截成两段的数 $\lceil \frac{b^k}{p}\rceil p$，它被截成 $1 \ |\  \lceil \frac{b^k}{p}\rceil p-b^k$，变成 $(\lceil \frac{b^k}{p}\rceil -b^k)b-1\equiv 0 \pmod p$，即 $b^{k+1}\equiv -1 \pmod p$。

